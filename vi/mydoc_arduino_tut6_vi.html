<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="huong_dan,  ">
<title>Điều khiển và Giám sát một thiết bị bằng Smartphone qua BLE với bo mạch VBLUno51 | VBLUno51 board</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-orange.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/vbluno2_small.png">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="https://vngiotlab.github.io/vblunofeed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });
            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });
            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });
        });
    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">

        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            
                        
            <img src="images/pic_topnav.png" alt="Bo mạch VBLUno51">
            <a class="fa fa-home fa-lg navbar-brand" href="index_vi.html">&nbsp;<span class="projectTitle"> VBLUno51 - VNG Bluetooth Low Energy UNO nRF51822 - Mạch phát triển ứng dụng cho IoT</span>                        
            
            </a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i></a></li>
                <!-- entries without drop-downs appear here -->
                                                        
                                
                    
                    
                    <li><a href="news">Tin mới</a></li>
                    
                    
                                        
                               
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                    
                    
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tài nguyên liên kết<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                            
                            <li><a href="https://goo.gl/bISeQl" target="_blank">VBLUno trên Facebook</a></li>
                            
                            
                            
                            <li><a href="https://goo.gl/w8gQHT" target="_blank">Cửa hàng bán VBLUno</a></li>
                            
                            
                            
                            <li><a href="https://goo.gl/kpLmQs" target="_blank">Mô đun DAPLink (CMSIS-DAP)</a></li>
                            
                            
                            
                            <li><a href="https://goo.gl/1nj0LZ" target="_blank">VBLUno trên diễn đàn Arduino.vn</a></li>
                            
                            
                        </ul>
                    </li>
                    
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">SDK & OS hỗ trợ<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                            
                            <li><a href="mydoc_getstart_arduino_vi.html">Arduino IDE</a></li>
                            
                            
                            
                            <li><a href="mydoc_getstart_mbed_vi.html">ARM mbed-OS</a></li>
                            
                            
                            
                            <li><a href="mydoc_getstart_mynewt_vi.html">Apache Mynewt-OS</a></li>
                            
                            
                            
                            <li><a href="mydoc_getstart_zephyr_vi.html">Zephyr</a></li>
                            
                            
                            
                            <li><a href="mydoc_getstart_riot_vi.html">RIOT-OS</a></li>
                            
                            
                            
                            <li><a href="mydoc_getstart_nordicsdk_vi.html">Nordic SDK</a></li>
                            
                            
                        </ul>
                    </li>
                    
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Ý kiến<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
                            
                            <li><a href="https://github.com/VNGIoTLab/vbluno/issues" target="_blank">Gửi yêu cầu trên Github</a></li>
                            
                            
                            
                            <li><a href="https://www.facebook.com/bleviet/messages" target="_blank">Gửi tin nhắn trực tiếp trên Facebook</a></li>
                            
                            
                        </ul>
                    </li>
                    
                    
                    <li><a class="link-vi" href="/vbluno/index.html">ENGLISH</a></li>
                    <!-- for test in local -->
                    <!-- <li><a class="link-vi" href="/index.html">ENGLISH</a></li> -->

                
                

                <!--comment out this block if you want to hide search-->
                <li>
                
                    <!--start search-->
                    <div id="search-demo-container">                    
                        <input type="text" id="search-input" placeholder="tìm kiếm...">
                        <ul id="results-container"></ul>
                    </div>

                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search_vi.json',
                                searchResultTemplate: '<li><a href="{url}" title="Điều khiển và Giám sát một thiết bị bằng Smartphone qua BLE với bo mạch VBLUno51">{title}</a></li>',
                    noResultsText: 'Không có kết quả nào được tìm thấy.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                

                </li>                
            </ul>    

        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Bo mạch VBLUno51 </li>
    
    
            
        
    
    <li>
        <a href="#">==VNG 12+1 BOT BATTLE==</a>
        <ul>
            

            

            
            
            
            <li><a href="mydoc_bot_template_vi.html">Các mã nguồn mẫu cho Bot</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Tổng quan</a>
        <ul>
            

            

            
            
            
            <li><a href="mydoc_introduction_vi.html">Giới thiệu VBLUno51</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_over_hardware_vi.html">Chú ý các phiên bản phần cứng (quan trọng)</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_over_sdk_vi.html">Software Development Kit</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_over_appcanmake_vi.html">Bạn có thể tạo được các ứng dụng gì với VBLUno51?</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Tài liệu</a>
        <ul>
            

            

            
            
            
            <li><a href="https://goo.gl/HUdV1Q" target="_blank">Đặc tả Nordic nRF51822</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_doc_hardware_vi.html">Sơ đồ nguyên lý & PCB</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_doc_pinout_vi.html">Pinout</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_doc_fritzing_vi.html">Fritzing Part</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_doc_daplink_vi.html">Nâng cấp firmware cho DAPLink</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://goo.gl/oVdvcv" target="_blank">mbed Serial driver (Chỉ với Windows)</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Bắt đầu thôi!</a>
        <ul>
            

            

            
            
            
            <li><a href="mydoc_getstart_arduino_vi.html">Sử dụng Arduino IDE</a></li>
            
            
            
            
            <li class="subfolders">
                <a href="#">Sử dụng mbed-OS</a>
                <ul>
                    
                    
                    
                    <li><a href="mydoc_getstart_mbedonline_vi.html">mbed Online Compiler</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_getstart_gnuarm_eclipse_vi.html">GNU ARM Embedded & Eclipse IDE (khuyên dùng)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_getstart_keil_vi.html">Keil uVision</a></li>
                    
                    
                    
                </ul>
            </li>
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Công nghệ Bluetooth Low Energy (BLE)</a>
        <ul>
            

            

            
            
            
            <li><a href="mydoc_ble_vi.html">Giới thiệu công nghệ Bluetooth Low Energy</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://goo.gl/5q7jC4" target="_blank">Hướng dẫn BLE với mbed-OS</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Loạt bài hướng dẫn</a>
        <ul>
            
            
            <li class="subfolders">
                <a href="#">Adruino</a>
                <ul>
                    
                    
                    
                    <li><a href="mydoc_arduino_tut1_vi.html">Tut1 - Thiết bị đo nhịp tim (HRM) với VBLUno51</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_arduino_tut2_vi.html">Tut2 - Thiết bị Beacons với VBLUno</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_arduino_tut3_vi.html">Tut3 - Đo nhiệt độ bên trong chip nRF51822</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_arduino_tut4_vi.html">Tut4 - Nhiệt kế y tế (HTM) với VBLUno</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_arduino_tut5_vi.html">Tut5 - Truyền thông giữa Smartphone và máy tính với “UART over BLE”</a></li>
                    
                    
                    
                    
                    
                    <li class="active"><a href="mydoc_arduino_tut6_vi.html">Tut6 - Điều khiển/Giám sát một thiết bị bất kỳ bằng Smartphone thông qua BLE</a></li>
                    
                    
                    
                </ul>
            </li>
            
            

            
            
            <li class="subfolders">
                <a href="#">mbed-OS</a>
                <ul>
                    
                    
                    
                    <li><a href="mydoc_mbed_tut1_vi.html">Tut1 - Lập trình/Gỡ lỗi cho VBLUno bằng pyOCD, OpenOCD trên GNU ARM Embedded + Eclipse</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mydoc_mbed_tut2_vi.html">Tut2 - BLE Beacons</a></li>
                    
                    
                    
                </ul>
            </li>
            
            

            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Mã nguồn ví dụ</a>
        <ul>
            

            

            
            
            
            <li><a href="mydoc_code_arduino_vi.html">Arduino</a></li>
            
            
            

            


            
            
            
            
            <li><a href="mydoc_code_mbed_vi.html">mbed-OS</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Video</a>
        <ul>
            

            

            
            
            
            <li><a href="https://goo.gl/Vi0mpo" target="_blank">Ví dụ BLE Serial</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://goo.gl/01X4oM" target="_blank">Robot điều khiển từ xa qua BLE với VBLUno</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Ứng dụng mobile cho BLE</a>
        <ul>
            

            

            
            
            
            <li><a href="https://goo.gl/i6DNtP" target="_blank">iBeacon & Eddystone Scanner (Android)</a></li>
            
            
            
            
            <li class="subfolders">
                <a href="#">Nordic nRF Toolbox</a>
                <ul>
                    
                    
                    
                    <li><a href="https://goo.gl/s3fbVW" target="_blank">Android</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://goo.gl/GH8gom" target="_blank">iOS</a></li>
                    
                    
                    
                </ul>
            </li>
            
            

            


            
            
            
            
            <li><a href="https://goo.gl/sFbubD" target="_blank">nRF UART 2.0 (Android)</a></li>
            
            
            
            
            <li class="subfolders">
                <a href="#">Mã nguồn (mở)</a>
                <ul>
                    
                    
                    
                    <li><a href="https://goo.gl/Et1atP" target="_blank">Nordic nRFToolbox (Android)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="https://goo.gl/rdTll8" target="_blank">BluetoohLeGatt Example (Android)</a></li>
                    
                    
                    
                </ul>
            </li>
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Liên kết</a>
        <ul>
            

            

            
            
            
            <li><a href="http://iotviet.com.vn" target="_blank">Cửa hàng IoTViet</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://zalopay.vn" target="_blank">VNG ZaloPay – (Ứng dụng thanh toán tự động, có dùng BLE)</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://goo.gl/YCxUeK" target="_blank">VNG CSM Router (Chuyên dụng cho Phòng máy)</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://www.facebook.com/groups/iotalliancevn/" target="_blank">Vietnam IoT Alliance page</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://developer.mbed.org/" target="_blank">ARM mbed  OS developer site</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://iotmaker.vn" target="_blank">Cửa hàng IoTMakerVN</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
    
    <li>
        <a href="#">Liên hệ</a>
        <ul>
            

            

            
            
            
            <li><a href="https://goo.gl/c3sbnk" target="_blank">Cửa hàng</a></li>
            
            
            

            


            
            
            
            
            <li><a href="https://www.facebook.com/bleviet/" target="_blank">Bluetooth Low Energy – BLE Vietnam page</a></li>
            
            
            

            


            
            
        </ul>
    </li>
                
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->    
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Điều khiển và Giám sát một thiết bị bằng Smartphone qua BLE với bo mạch VBLUno51</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->



	<script>
	$( document ).ready(function() {
	  // Handler for .ready() called.

	$('#toc_vi').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

	/* this offset helps account for the space taken up by the floating toolbar. */
	$('#toc_vi').on('click', 'a', function() {
	  var target = $(this.getAttribute('href'))
	    , scroll_target = target.offset().top

	  $(window).scrollTop(scroll_target - 10);
	  return false
	})
	  
	});
	</script>

	<div id="toc_vi"></div>



    


    

  <hr />
<h2 id="Điều-khiển-giám-sát-thiết-bị-qua-ble-với-bo-mạch-vbluno51">Điều khiển, giám sát thiết bị qua BLE với bo mạch VBLUno51</h2>

<ul>
  <li>
    <p>Trong các bài viết trước, chúng tôi đã trình bày một số ứng dụng điển hình của giao tiếp Bluetooth Low Energy (BLE) như: Heart Rate Mesuarement, Health Thermometer, Beacons. Các ứng dụng này sử dụng các services đã được Bluetooth SIG định nghĩa sẵn. Danh sách các services có thể xem tại <a href="https://www.bluetooth.com/specifications/gatt/services">ĐÂY</a></p>
  </li>
  <li>
    <p>Dữ liệu truyền qua giao tiếp BLE có thể được tổ chức thành các services, trong services lại bao gồm các characteristics. Khi này hai BLE Node cần kết nối với nhau.</p>
  </li>
  <li>
    <p>Bluetooth SIG định nghĩa sẵn một số services cho các ứng dụng điển hình, nhưng rõ ràng là chúng không đầy đủ, ví dụ như ứng dụng điều khiển một thiết bị bất kỳ. Để phục vụ các ứng dụng như vậy, chúng ta có thể tự định nghĩa các services cho từng trường hợp cụ thể.</p>
  </li>
  <li>
    <p>Các ứng dụng điều khiển thiết bị yêu cầu khả năng ghi dữ liệu từ GATT Client (Smartphones) xuống GATT Server (BLE Device) và ngược lại. Bài viết này chúng tôi minh họa việc thiết kế và cài đặt một services đơn giản cho BLE, ứng dụng điều khiển LED và nhận tín hiệu trạng thái BUTTON, gọi tắt là <strong>VBLUno51_LED_BUTTON Service</strong>.</p>
  </li>
  <li>
    <p>VBLUno51_LED_BUTTON Service</p>
  </li>
</ul>

<p>Cấu trúc của VBLUno51-LED BUTTON Service</p>

<p><img src="images/arduino/tut/tut6/uuid.png" alt="" /></p>

<ul>
  <li>
    <p>Service này bao gồm hai characteristic cho hai mục đích khác nhau:</p>

    <ul>
      <li>
        <p><strong>LED Characteristic:</strong> Giúp Master truyền tín hiệu điều khiển xuống thiết bị, với kiểu WRITE. Tương tự, các bạn cũng có thể chuyển thành tín hiệu điều khiển bất kỳ, không chỉ để bật tắt LED.</p>
      </li>
      <li>
        <p><strong>BUTTON Characteristic</strong>: Với kiểu NOTIFY, characteristic này cho phép thiết bị BLE có thể gửi giá trị cập nhật đến Master. Ta có thể sử dụng characteristic này để gửi giá trị trạng thái nút bấm, giá trị cảm biến lên Smartphones để xử lý. Với characteristic kiểu Notify, tối thiểu chúng ta cần một Descriptor đi kèm, đó là Client Characteristic Configuration Desp. Descriptor này nằm ở phía Master giúp cho phép nhận hoặc không nhận giá trị Notify gửi lên từ BLE Device.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Như vậy, với Services được thiết kế riêng này, chúng ta có thể cài đặt tính năng điều khiển/giám sát thiết bị bất kỳ từ các điện thoại thông minh (hoặc Tablet/PC) qua giao tiếp BLE. Phần tiếp theo trình bày việc cài đặt service này trên Arduino IDE sử dụng kit VBLUno51 của VNG IoTLab và viết phần mềm chạy trên Android.</p>
  </li>
</ul>

<hr />
<h2 id="firmware-cho-mạch-vbluno51">Firmware cho mạch VBLUno51</h2>

<ul>
  <li>
    <p>Bài toán minh họa:</p>

    <ul>
      <li>
        <p>Bo mạch VBLUno51 kết nối với Smartphone thông qua giao tiếp BLE;</p>
      </li>
      <li>
        <p>Chức năng:</p>

        <ul>
          <li>
            <p>Smartphone –&gt; VBLUno51: <code class="highlighter-rouge">Điều khiển bật tắt LED</code> bằng Smartphones;</p>
          </li>
          <li>
            <p>VBLUno51 –&gt; Smartphone: <code class="highlighter-rouge">Mỗi lần nhấn nút bấm</code> trên bo mạch VBLUno51 sẽ truyền một biến giá trị (tăng từ 0x00 đến 0xFF) lên mobile.</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Thực hiện:</p>

    <ul>
      <li>
        <p>Tải mã nguồn chương trình viết trên Arduino IDE cho VBLUno51 tại <a href="https://github.com/VNGIoTLab/vbluno_ble_led_button">ĐÂY</a> . Xem thư mục <code class="highlighter-rouge">firmware_vbluno51</code></p>
      </li>
      <li>
        <p>Upload code xuống bo mạch VBLUno51</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Một số điểm chú ý trong code:</p>
  </li>
</ul>

<p>Xử lý sự kiện khi nhận được dữ liệu truyền từ Mobile đến. Tùy giá trị nhận được mà bật hoặc tắt LED.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>void gattserverWriteCallback(const GattWriteCallbackParams *Handler) {
  
  static uint8_t buf[TXRX_BUF_LEN];
  static uint16_t bytes_read=0;

  if(Handler-&gt;handle == led_characteristic.getValueAttribute().getHandle()) {
           
    // Read the value of characteristic
    ble.readCharacteristicValue(led_characteristic.getValueAttribute().getHandle(), 
                                buf, 
                                &amp;bytes_read);       
    if (bytes_read &gt; 0) {                             
      //on LED
      if (buf[0] == 0) {
        digitalWrite(LED, HIGH);
        Serial.println("Turn LED on");
      }
      //off LED
      else {
        digitalWrite(LED, LOW);
        Serial.println("Turn LED off");
      }      
    }//if2
  }//if  
}
</code></pre>
</div>

<p>Mỗi khi nhấn Button trên VBLUno51, thực hiện tăng biến lên một giá trị và gửi lên Mobile.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//ISR for Button interrupt
void buttonIsr() {   

  button_char_value[0]++;
  
  //push data to Mobile
  ble.updateCharacteristicValue(button_characteristic.getValueAttribute().getHandle(), 
                                (const uint8_t*)button_char_value, 
                                1);
  
  Serial.print("Send data to Mobile via BLE: ");
  Serial.println(button_char_value[0]);                               
}
</code></pre>
</div>

<ul>
  <li>Thử dùng phần mềm BLE Scanner để discovery kết nối BLE từ VBLUno51.</li>
</ul>

<p><img src="images/arduino/tut/tut6/service.png" alt="" /></p>

<hr />
<h2 id="viết-phần-mềm-điều-khiển-trên-android-os">Viết phần mềm điều khiển trên Android OS</h2>

<ul>
  <li>
    <p>Tải mã nguồn chương trình viết ứng dụng trên Android tại <a href="https://github.com/VNGIoTLab/vbluno_ble_led_button">ĐÂY</a>. Xem thư mục <code class="highlighter-rouge">android</code></p>
  </li>
  <li>
    <p>Một số điểm chú ý trong code:</p>
  </li>
</ul>

<p><code class="highlighter-rouge">LedButtonGattAttributes class</code>: Khai báo các thông tin về VBLUno51_LED_BUTTON services. Đây là dịch vụ mà phần mềm này mong muốn kết nối.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>public class LedButtonGattAttributes {

    /**
     *  brief      UUID cho các services và characteristic
     */
    //Bot service gồm 5 characteristics
    public static final String led_button_service_uuid    = "0000FFF8-0000-1000-8000-00805F9B34FB";
    public static final String led_char_uuid              = "0000FFF9-0000-1000-8000-00805F9B34FB";  //WRITE-uchar
    public static final String button_char_uuid           = "0000FFFA-0000-1000-8000-00805F9B34FB";  //NOTIFY-uchar

    public static final int LED_ON = 0;
    public static final int LED_OFF = 1;

    private static HashMap&lt;String, String&gt; attributes = new HashMap();
    public static String CLIENT_CHARACTERISTIC_CONFIG = "00002902-0000-1000-8000-00805f9b34fb";

    static {
        attributes.put(led_button_service_uuid, "LED_BUTTON_SERVICE");
        attributes.put(led_char_uuid, "LED");
        attributes.put(button_char_uuid, "BUTTON");        
    }

    public static String lookup(String uuid, String defaultName) {
        String name = attributes.get(uuid);
        return name == null ? defaultName : name;
    }
}
</code></pre>
</div>

<p><code class="highlighter-rouge">BluetoothLeService class</code>: Chú ý đến thủ tục ghi Dữ liệu xuống Device (VBLUno51) và Cho phép device Notify dữ liệu lên mobile</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/*
     *   @brief:     Hàm ghi giá trị xuống 1 custom characteristic
     */
    public void writeCustomCharacteristic(String serviceUUID,
                                          String charUUID,
                                          int value) {
        if (mBluetoothAdapter == null || mBluetoothGatt == null) {
            Log.w(TAG, "BluetoothAdapter not initialized");
            return;
        }
        /*check if the service is available on the device*/
        BluetoothGattService mCustomService = mBluetoothGatt.getService(UUID.fromString(serviceUUID));
        if(mCustomService == null){
            Log.w(TAG, "Custom BLE Service not found");
            return;
        }
        /*get the read characteristic from the service*/
        BluetoothGattCharacteristic mWriteCharacteristic = mCustomService.getCharacteristic(UUID.fromString(charUUID));
        mWriteCharacteristic.setValue(value,android.bluetooth.BluetoothGattCharacteristic.FORMAT_UINT8,0);
        if(mBluetoothGatt.writeCharacteristic(mWriteCharacteristic) == false){
            Log.w(TAG, "Failed to write characteristic");
        }
    }
    
    /*
    *   @brief:     Hàm cho phép notify theo thông tin UUID của service, characteristic
     */

    public void notifyCustomCharacteristic(String serviceUUID, 
                                           String charUUID, 
                                           boolean state) {

        if (mBluetoothAdapter == null || mBluetoothGatt == null) {
            Log.w(TAG, "BluetoothAdapter not initialized");
            return;
        }

        /*check if the service is available on the device*/
        BluetoothGattService mCustomService = mBluetoothGatt.getService(UUID.fromString(serviceUUID));
        if(mCustomService == null){
            Log.w(TAG, "Custom BLE Service not found");
            return;
        }

        BluetoothGattCharacteristic mCharacteristic = mCustomService.getCharacteristic(UUID.fromString(charUUID));
        setCharacteristicNotification(mCharacteristic, state);

}
</code></pre>
</div>

<p><code class="highlighter-rouge">DeviceControlActivity class</code>: Tương tác với control trên forrm</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/*
     *  @brief      Hành động khi nhấn nút LED
     */
    public void onClickLed(View v){
        if(mBluetoothLeService != null) {
            int value = LedButtonGattAttributes.LED_OFF;
            if (tgbLed.isChecked()) {
                value = LedButtonGattAttributes.LED_ON;
            }
            else {
                value = LedButtonGattAttributes.LED_OFF;
            }

            mBluetoothLeService.writeCustomCharacteristic(
                    LedButtonGattAttributes.led_button_service_uuid,
                    LedButtonGattAttributes.led_char_uuid,
                    value);

            Log.v(TAG, tgbLed.getText().toString());

        }
    }

    /*
     *  @brief      Thủ tục xử lý dữ liệu nhận được từ BLE Device (VBLUno51)
     */
    public void processBleData(String data){
            lblButtonValue.setText("Value: " + data);
}
</code></pre>
</div>

<hr />
<h2 id="kết-quả-demo">Kết quả demo</h2>

<ul>
  <li>Cấp nguồn để mạch VBLUno51 làm việc. Sau đó chạy phần mềm Android đã viết. Thực hiện quét các thiết bị BLE sẽ tìm thấy VBLUno51 với tên <code class="highlighter-rouge">LED_BUTTON_51</code></li>
</ul>

<p><img src="images/arduino/tut/tut6/scan.png" alt="" /></p>

<ul>
  <li>Sau khi đã Connect, thử nhấn Toggle Button trên form để bật tắt LED. Nhấn nút bấm trên VBLUno51 để xem kết quả hiển thị trên phần mềm Android.</li>
</ul>

<p><img src="images/arduino/tut/tut6/control.png" alt="" /></p>

<p>Với cách làm tương tự, các bạn có thể tạo ra nhiều BLE Services phù hợp cho ứng dụng của mình.</p>

<p><code class="highlighter-rouge">Các bạn có thể theo dõi Trang facebook của VBLUno51 để có thể xem các video hướng dẫn mới nhé</code>
<a href="https://www.facebook.com/bleviet">Fan page</a></p>


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_huong_dan.html" class="btn btn-default navbar-btn cursorNorm" role="button">huong_dan</a>
        
        
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2017 VNG Corporation. All rights reserved. <br />
 Site last generated: Aug 8, 2017 <br />
<p><img src="images/company_logo_medium.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>